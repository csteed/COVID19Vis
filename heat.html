<!DOCTYPE html>
<meta charset="utf-8" />
<html>
  <head>
    <!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
    <script src="js/d3.min.js"></script>
    <script src="js/d3-array.min.js"></script>

    <style>
      body {
        font: 12px sans-serif;
        margin: 4px 20px 0px 20px;
        /* background: gray; */
        background-color: whitesmoke;
      }

      .top {
        background-color: whitesmoke;
        overflow: hidden;
        position: fixed;
        top: 0;
        width: 100%;
      }

      .main {
        margin-top: 400px;
      }
    </style>
  </head>
  <body>
    <h2>COVID-19 Time Series Heatmap Visualization</h2>
    <h3>Description:</h3>
    <p>
      This page shows counts of confirmed cases, deaths, and recovered cases for the
      COVID-19 pandemic. The data is pulled from the 
      <a href="https://github.com/CSSEGISandData/COVID-19" target="_blank">JHU CSSE</a> 
      data repository. 
    </p>
    <h3>Instructions:</h3>
    <p>
      <strong>Show Daily Change: </strong>If checked, charts show daily change. If unchecked, charts show case totals.<br/>
      <strong>Selected Country/Region: </strong>Select 'All Countries' to see country statistics. Select an individual country to see state/province statistics, if available. If no state/province statistics are stored, the totals will be shown.<br/>
      <strong>Highlight State/Province: </strong>Select a country to highlight its line in the charts.<br/>
      <strong>Hover Query: </strong>Hover over lines in the chart to highlight values.<br/>
    </p>

    <h3>Controls:</h3>
    <input id="movingRangeCheckbox" type="checkbox" onChange="movingRangeCheckboxChanged()"/>
    <label for="movingRangeCheckbox">Show Daily Change</label>
    <br/><br/>

    <label for="countrySelect">Select Country/Region: </label>
    <select id="countrySelect" onChange="countrySelectChanged()">
    </select>
    <br/><br/>

    <label for="stateSelect">Highlight State/Province: </label>
    <select id="stateSelect" onChange="stateSelectChanged()" disabled>
    </select>
    <br/><br/>

    <hr>

    <h3>Chart:</h3>
    <div id="chart"></div>

  </body>

  <script>
    let parseTime = d3.timeParse("%m/%d/%Y");
    let allFileData;
    let chartData;
    const chartHeight = 200;
    const rowHeight = 12;
    const margin = {top: 50, right: 20, bottom: 20, left: 170};

    const removeSpaces = (str) => {
      return str.replace(/\s+/g, '');
    };

    const getSelectedCountry = () => {
      const select = document.getElementById('countrySelect');
      return select.options[select.selectedIndex].text;
    }

    const getSelectedState = () => {
      const select = document.getElementById('stateSelect');
      if (select.selectedIndex >= 0 && select.selectedIndex < select.options.length) {
        return select.options[select.selectedIndex].text;
      }
      return null;
    }

    const getShowMovingRange = () => {
      return document.getElementById('movingRangeCheckbox').checked;
    }

    const movingRangeCheckboxChanged = () => {
      createCharts();
    }

    const stateSelectChanged = () => {
      const selectedCountry = getSelectedCountry();
      const selectedState = getSelectedState();
      allFileData.forEach(fileData => {
        // console.log(fileData);
        const country = fileData.countries.find(d => d.name === selectedCountry);
        const state = country.states.find(d => d.name === selectedState);
        const path = d3.select(`#${fileData.name}`).select('svg').selectAll('path');
        if (state) {
          // const path = d3.select(`#${fileData.name}`).select('svg').selectAll('path');
          path.style("mix-blend-mode", null).attr("stroke", "#ddd");
          path.attr("stroke", d => d.name === state.name ? null : "#ddd").filter(d => d.name === state.name).raise();
        } else {
          path.style("mix-blend-mode", "multiply").attr("stroke", null);
        }
      });
    }

    const countrySelectChanged = () => {
      populateStateSelect();
      createCharts();
    }

    const populateCountriesSelect = (countries) => {
      const select = document.getElementById('countrySelect');
      countries.unshift('All Countries');
      countries.forEach(country => {
        select.options[select.options.length] = new Option(country);
      });
    };

    const populateStateSelect = () => {
      const select = document.getElementById('stateSelect');
      for (let i = select.options.length - 1; i >= 0; i--) {
        select.remove(i);
      }

      const selectedCountry = getSelectedCountry();
      if (selectedCountry === 'All Countries') {
        select.disabled = true;
      } else {
        var selectedCountryData = allFileData[0].countries.find(d => d.name === selectedCountry);
        if (selectedCountryData && selectedCountryData.states.length > 0) {
          const stateNames = selectedCountryData.states.map(d => d.name);
          stateNames.unshift('All States/Provinces');
          stateNames.forEach(stateName => {
            select.options[select.options.length] = new Option(stateName);
          })
          select.disabled = false;
        } else {
          select.disabled = true;
        }
      }
    };

    const processData = (rawFileData) => {
      if (rawFileData) {
        var processedData = [];
        rawFileData.forEach(fileData => {
          const nestedData = d3.nest()
            .key(d => d["Country/Region"]).sortKeys(d3.ascending)
            .key(d => d["Province/State"]).sortKeys(d3.ascending)
            .entries(fileData.data);
          
          var dates = [];
          fileData.data.columns.forEach(column => {
            const date = parseTime(column);
            if (date) {
              dates.push(column);
            }
          });

          var countries = [];
          nestedData.forEach(countryNode => {
            var checkValues = false;

            var country = {
              name: countryNode.key,
              values: null,
              states: [],
              counties: []
            };
            countries.push(country);

            countryNode.values.forEach(stateNode => {
              var values = dates.map(date => stateNode.values[0][date]);
              if (stateNode.key !== "null") {
                if (stateNode.key.includes(",")) {
                  country.counties.push({
                    name: stateNode.key,
                    values: values
                  });
                } else {
                  country.states.push({
                    name: stateNode.key,
                    values: values
                  });
                }
              } else {
                country.values = values;
              }
            });

            // if (country.name === 'US') {
            //   console.log(fileData.filename);
            //   console.log(country);
            //   let checkValues = Array.from(country.states[0].values);
            //   for (let i = 1; i < country.states.length; i++) {
            //     for (let j = 0; j < country.values.length; j++) {
            //       checkValues[j] = checkValues[j] + country.states[i].values[j];
            //     }
            //   }

            //   console.log(country.values);
            //   console.log(checkValues);
            //   console.log(d3.sum(checkValues));
            // }

            if (!country.values) {
              // country.values = [];
              // console.log(country);
              // need to sum up states to get country totals
              // console.log(country.name + " needs rollup");
              country.values = Array.from(country.states[0].values);
              for (let i = 1; i < country.states.length; i++) {
                for (let j = 0; j < country.values.length; j++) {
                  country.values[j] = country.values[j] + country.states[i].values[j];
                }
              }
            }
          });

          var name = fileData.filename.includes("confirmed") ? "Confirmed" : fileData.filename.includes("deaths") ? "Death" : fileData.filename.includes("recovered") ? "Recovered" : "Other";          
          processedData.push({
            name: name,
            title: `${name} Case Counts`,
            y: "Cases",
            countries: countries,
            dates: dates.map(d => parseTime(d))
          });

        });
        return processedData;
      }
    };

    const getMovingRangeValues = (values) => {
      let movingRangeValues = [];
      movingRangeValues.push(0);
      for (let i = 1; i < values.length; i++) {
        movingRangeValues[i] = values[i] - values[i-1];
      }
      return movingRangeValues;
    }

    // const formatTime = d3.timeFormat('%m-%d-%Y');
    const formatTime = d3.timeFormat('%-m/%-d');

    const loadData = () => {
      if (allFileData) {
        const fileData = allFileData.find(d => d.name === 'Confirmed');
        console.log(fileData);
        if (fileData) {
          chartData = {
            // dates: fileData.dates.map(d => formatTime(d)),
            dates: fileData.dates,
            names: [...fileData.countries.map(d => d.name)],
            values: [...fileData.countries.map(d => d.values)]
          };
          // console.log([...fileData.countries.map(d => d.name)]);
          
          // console.log([...fileData.countries.map(d => d.values)]);
        }

        // const selectedCountry = getSelectedCountry();
        // const showMovingRange = getShowMovingRange();
        // // console.log(selectedCountry);

        // chartData = [];

        // if (selectedCountry === 'All Countries') {
        //   allFileData.forEach(fileData => {
        //     var series = [];
        //     // console.log(fileData);
        //     fileData.countries.forEach(countryData => {
        //       // if (countryData.values) {
        //         series.push({
        //           name: countryData.name,
        //           values: showMovingRange ? getMovingRangeValues(countryData.values) : countryData.values
        //         });
        //       // }
        //     });
        //     chartData.push({
        //       name: fileData.name,
        //       title: fileData.title,
        //       y: getShowMovingRange() ? "Daily Change" : "Cases", //fileData.y,
        //       series: series,
        //       dates: fileData.dates
        //     });
        //   });
        // } else {
        //   allFileData.forEach(fileData => {
        //     var series = [];
        //     const country = fileData.countries.find(d => d.name === selectedCountry);
            
        //     if (country.states.length > 0) {
        //       country.states.forEach(state => {
        //         series.push({
        //           name: state.name,
        //           // values: state.values
        //           values: showMovingRange ? getMovingRangeValues(state.values) : state.values
        //         });
        //       });
        //     } else {
        //       series.push({
        //         name: country.name,
        //         values: showMovingRange ? getMovingRangeValues(country.values) : country.values
        //         // values: country.values
        //       });
        //     }
            
        //     chartData.push({
        //       name: fileData.name,
        //       title: fileData.title,
        //       y: getShowMovingRange() ? "Daily Change" : "Cases",
        //       series: series,
        //       dates: fileData.dates
        //     });
        //   });
        // }
      }
      console.log(chartData);
    }

    const createChart = () => {
      loadData();
      d3.select('#chart').selectAll('*').remove();
      if (chartData) {
        let names = chartData.names;
        let dates = chartData.dates;
        let values = chartData.values;
        d3.select('#chart').selectAll('*').remove();

        const divWidth = document.getElementById('chart').clientWidth;
        const width = divWidth - margin.left - margin.right;
        const height = names.length * rowHeight;

        const svg = d3.select('#chart').append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom);

        const g = svg.append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        var maxDate = new Date(d3.max(dates));
        maxDate.setDate(maxDate.getDate() + 1);
        console.log(maxDate);

        const x = d3.scaleTime()
          .domain([d3.min(dates), maxDate])
          .rangeRound([0, width])
        console.log(x.domain());
        // const x = d3.scaleBand()
        //   // .domain([d3.min(dates),d3.max(dates)])
        //   .domain(dates)
        //   .rangeRound([0, width]);

        const y = d3.scaleBand()
          .domain(names)
          .rangeRound([0, height]);
        
        // const color = d3.scaleSequential([1, d3.max(values, d => d3.max(d))], d3.interpolatePuRd);
        const color = d3.scaleSequentialSqrt(t => d3.interpolateReds((t + 0.15) / 2))
          .domain([1, d3.max(values, d => d3.max(d))]);
        // ([1, d3.max(values, d => d3.max(d))], d3.interpolatePuRd);
        // console.log(color.domain());

        g.append("g")
          .call(d3.axisTop(x))
          .call(g => g.select(".domain").remove());
          // .call(g => g.selectAll("text").attr("y", 0).attr("x", 9).attr("dy", ".35em").attr("transform", "rotate(-90)").style("text-anchor", "start"));

        g.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(y).tickSize(0))
          .call(g => g.select(".domain").remove());

        const row = g.append("g")
          .selectAll("g")
          .data(values)
          .join("g")
            .attr("transform", (d, i) => `translate(0,${y(names[i])})`)
            .on('mouseover touchover', (d, i) => {
              d3.select(".axis--y")
                .selectAll('text')
                .attr("font-weight", t => t === names[i] ? "bold" : "normal");
            })
            .on('mouseout touchout', (d, i) => {
              d3.select(".axis--y")
                .selectAll('text')
                .attr("font-weight", "normal");
            });
        
        function format (d) {
          const f = d3.format(",d");
          return isNaN(d) ? "N/A cases" 
            : d === 0 ? "0 cases"
            : `${f(d)} cases`
        }

        // console.log(row.data);
        // console.log(dates);
        row.selectAll("rect")
          .data(d => d)
          .join("rect")
            .attr("x", (d, i) => x(dates[i]) + 1)
            // .attr("x", (d, i) => x(dates[i]))
            .attr("width", (d, i) => x(dates[i+1]) - x(dates[i]) - 1)
            // .attr("width", x.bandwidth())
            .attr("height", y.bandwidth() - 1)
            .attr("fill", d => isNaN(d) ? "none" : d === 0 ? "whitesmoke" : color(d))
          .append("title")
            .text((d, i) => `${dates[i]}: ${format(d)}`);
      }
    };

    const loadFiles = (filenames) => {
      if (filenames) {
        let rawFileData = [];
        Promise.all(filenames.map(f => d3.csv(f, d3.autoType)))
          .then(function (d) {
            for (let i = 0; i < d.length; i++) {
              rawFileData.push({
                filename: filenames[i],
                data: d[i]
              });
            }

            let countries = new Set();
            rawFileData.forEach(fileData => {
              fileData.data.forEach(d => {
                countries.add(d["Country/Region"]);
              });
            });
            populateCountriesSelect([...countries].sort(d3.sortAscending));

            allFileData = processData(rawFileData);
            console.log(allFileData);
            createChart();
          })
          .catch (error => {
            console.log(error);
          });
      }
    };

    // const files = ['data/time_series_19-covid-Confirmed.csv', 
    //   'data/time_series_19-covid-Deaths.csv',
    //   'data/time_series_19-covid-Recovered.csv'];
    // const remoteFiles = ['https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv',
    //   'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv',
    //   'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv'];
    const remoteFiles = ['https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv',
      'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv',
      'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv'];

    loadFiles(remoteFiles);
    // loadFiles(files);

    // d3.csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv', d3.autoType)
    // d3.csv("data/time_series_19-covid-Confirmed.csv", d3.autoType)
    //   .then(function(data) {
    //     fileData = data;
    //     loadData();
    //     createChart(chartData[0]);
    //   })
    //   .catch(function(error) {
    //     console.log(error);
    //   });
  </script>
</html>
