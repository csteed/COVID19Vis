<!DOCTYPE html>
<meta charset="utf-8" />
<html>
  <head>
    <!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
    <script src="js/d3.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>

    <style>
      body {
        font: 12px sans-serif;
        margin: 4px 20px 0px 20px;
        /* background: gray; */
        background-color: whitesmoke;
      }

      .top {
        background-color: whitesmoke;
        overflow: hidden;
        position: fixed;
        top: 0;
        width: 100%;
      }

      .main {
        margin-top: 400px;
      }

      /* path {
        fill: #ccc;
        stroke: #fff;
        stroke-width: .5px;
      } */

      /* path:hover {
        fill: red;
      }  */
    </style>
  </head>
  <body>
    <div id='chart'></div>
  </body>

  <script>
    var width = 975, height = 610;
    var covid_data = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/03-23-2020.csv';

    // var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305])
    // var path = d3.geoPath();
    // console.log("here");
    // var svg = d3.select("#chart").append("svg")
    //   .attr("width", width)
    //   .attr("height", height);
    
    d3.json('data/counties-albers-10m.json')
      .then(us => {
        console.log(us);

        d3.csv(covid_data)
          .then(function(data) {
            console.log(data);
            data.map(d => d.Confirmed = +d.Confirmed);
            createCharts(us, data);
          })
          .catch(function(error) {
            console.log(error);
          });

        // const g = svg.append("g")
        //   .attr("fill", "none")
        //   .attr("stroke", "#000")
        //   .attr("stroke-linejoin", "round")
        //   .attr("stroke-linecap", "round");

        // g.append("path")
        //   .attr("stroke", "#aaa")
        //   .attr("stroke-width", 0.5)
        //   // .attr("fill", '#fff')
        //   // .attr("d", path(topojson.feature(us, us.objects.counties).features));
        //   .attr("d", path(topojson.mesh(us, us.objects.counties, (a, b) => a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0))));
        
        // g.append("path")
        //   .attr("stroke-width", 0.5)
        //   .attr("d", path(topojson.mesh(us, us.objects.states, (a, b) => a !== b)));

        // g.append("path")
        //   .attr("d", path(topojson.feature(us, us.objects.nation)));

        // g.selectAll("path")
        //   .data(topojson.feature(us, us.objects.counties).features)
        //   .enter().append("path")
        //     .attr("stroke", "#aaa")
        //     .attr("stroke-width", 0.5)
        //     .attr("d", path);
        
        // g.selectAll("path")
        //   .data(topojson.mesh(us, us.objects.counties, (a, b) => a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0)))
        //   .enter().append("path")
        //     .attr("stroke", "#aaa")
        //     .attr("stroke-width", 0.5)
        //     .attr("d", path);
        

        // var geojson = topojson.feature(topology, topology.objects.counties);
        // var geojson = topojson.mesh(us, us.objects.counties);
        // console.log(geojson);

        // svg.selectAll("path")
        //   .data(geojson.features)
        //   .enter().append("path")
        //     .attr("d", path);
      })
      .catch(error => {
        console.log(error);
      });
    // d3.json('data/counties-albers-10m.json', function(topology) {
    //   console.log("topojson", topology);
    //   var geojson = topojson.feature(topology, topology.objects.counties);
    //   console.log("geojson", geojson);

    //   svg.selectAll("path")
    //     .data(geojson.features)
    //     .enter().append("path")
    //       .attr("d", path);
    // });

    const createCharts = (us, data) => {
      console.log(us);
      console.log(data);

      var path = d3.geoPath();

      var svg = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height)

      const g = svg.append("g")
        .attr('class', 'mapcontainer')
        .attr("fill", "none")
        .attr("stroke", "#000")
        .attr("stroke-linejoin", "round")
        .attr("stroke-linecap", "round");

      function zoomed() {
        const mapG = svg.select('.mapcontainer');
        mapG.style('stroke-width', `${0.5 / d3.event.transform.k}px`);
        mapG.attr("transform", d3.event.transform);
      }

      const zoom = d3.zoom()
        .scaleExtent([1, 10])
        .on("zoom", zoomed);

      svg.call(zoom);

      g.append("path")
        .attr("stroke", "#aaa")
        .attr("stroke-width", 0.5)
        .attr("d", path(topojson.mesh(us, us.objects.counties, (a, b) => a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0))));
      
      g.append("path")
        .attr("stroke-width", 0.5)
        .attr("d", path(topojson.mesh(us, us.objects.states, (a, b) => a !== b)));

      g.append("path")
        .attr("d", path(topojson.feature(us, us.objects.nation)));

      projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305])

      const caseCountMap = new Map(data.filter(d => d.Confirmed > 0).map(d => [d.FIPS, d.Confirmed]));
      console.log(caseCountMap);
      console.log(caseCountMap.get("27113"))

      const features = topojson.feature(us, us.objects.counties).features
        .map(d => (d.value = caseCountMap.get(d.id), d))
        .filter(d => d.value)
        .sort((a, b) => b.value - a.value);

      const format = d3.format(",.0f");

      const color = d3.scaleSequentialSqrt(d3.interpolateBlues)
        .domain(d3.extent(features, d => d.value));
      console.log(d3.extent(features, d => d.value));

      const radius = d3.scaleSqrt([0, d3.quantile([...caseCountMap.values()].sort(d3.ascending), 0.985)], [0, 15])
      console.log(features);
      // console.log(features.map(d => d.value))
      // console.log(features.filter(d => d.value));
      g.append("g")
        .attr("fill", "brown")
        .attr("fill-opacity", 0.5)
        .attr("stroke", "#fff")
        .attr("stroke-width", 0.5)
        .selectAll("circle")
        .data(features)
        .join("circle")
          .attr("transform", d => `translate(${path.centroid(d)})`)
          .attr("r", d => radius(d.value))
          // .attr("fill", d => {console.log(color(d.value)); return color(d.value)} )
        .append("title")
          .text(d => `${d.properties.name} ${format(d.value)}`);
    };
  </script>
  
  </html>
